# ------------------------------
# -- authentik (Identity Provider / SSO)
# -- Updated/Created 2024-July-02
# Authentik configuration: https://docs.goauthentik.io/docs/installation/configuration
# ------------------------------
name: authentik # Project Name

networks:
    authentik-backend:
        name: authentik-backend

services:
    authentik_postgresql:
        image: docker.io/library/postgres:16-alpine
        container_name: authentik_postgresql
        shm_size: 128mb # https://hub.docker.com/_/postgres
        restart: unless-stopped
        user: ${PUID}:${PGID}
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"
                ]
            start_period: 20s
            interval: 30s
            retries: 5
            timeout: 5s
        networks:
            - authentik-backend
        volumes:
            - "../${APP_ROOT}/authentik/postgres:/var/lib/postgresql/data"

        environment:
            POSTGRES_PASSWORD: ${PG_PASS:?database password required}
            POSTGRES_USER: ${PG_USER:-authentik}
            POSTGRES_DB: ${PG_DB:-authentik}

    authentik_redis:
        image: docker.io/library/redis:alpine
        container_name: authentik_redis
        command: --save 60 1 --loglevel warning
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
            start_period: 20s
            interval: 30s
            retries: 5
            timeout: 3s
        networks:
            - authentik-backend
        volumes:
            - "../${APP_ROOT}/authentik/redis:/data"

    # Use the embedded outpost (2021.8.1+) instead of the seperate Forward Auth / Proxy Provider container
    authentik_server:
        image: ghcr.io/goauthentik/server:latest
        container_name: authentik_server
        restart: unless-stopped
        command: server
        user: ${PUID}:${PGID}
        depends_on:
            - authentik_postgresql
            - authentik_redis
        networks:
            - traefik
            - socket_proxy
            - authentik-backend

        environment:
            AUTHENTIK_REDIS__HOST: authentik_redis
            AUTHENTIK_POSTGRESQL__HOST: authentik_postgresql
            AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
            AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
            AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS:?database password required}

            AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
        env_file: ../.env
        volumes:
            - "../${APP_ROOT}/authentik/media:/media"
            - "../${APP_ROOT}/authentik/custom-templates:/templates"
        labels:
            - "traefik.enable=true"
            ## HTTP Routers
            - "traefik.http.routers.authentik-rtr.rule=Host(`authentik.${DOMAINNAME}`)"
            ## Individual Application forwardAuth regex (catch any subdomain using individual application forwardAuth)
            - "traefik.http.routers.authentik-output-rtr.rule=HostRegexp(`{subdomain:[a-z0-9-]+}.${DOMAINNAME}`) && PathPrefix(`/outpost.goauthentik.io/`)"
            ## HTTP Services
            - "traefik.http.routers.authentik-rtr.service=authentik-svc"
            - "traefik.http.services.authentik-svc.loadBalancer.server.port=9000"

    authentik_worker:
        image: ghcr.io/goauthentik/server:latest
        container_name: authentik_worker
        restart: unless-stopped
        # Removing `user: root` also prevents the worker from fixing the permissions
        # on the mounted folders, so when removing this make sure the folders have the correct UID/GID
        # (1000:1000 by default)
        # user: root
        user: ${PUID}:${PGID}
        command: worker
        depends_on:
            - authentik_postgresql
            - authentik_redis
        networks:
            - socket_proxy
            - authentik-backend
        environment:
            AUTHENTIK_REDIS__HOST: redis
            AUTHENTIK_POSTGRESQL__HOST: postgresql
            AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
            AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
            AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS:?database password required}
        volumes:
            - "../${APP_ROOT}/authentik/media:/media"
            - "../${APP_ROOT}/authentik/custom-templates:/templates"
            # - /var/run/docker.sock:/var/run/docker.sock # Uncomment if NOT using socket-proxy
            #- "./traefik/cert_export:/certs:ro" # If NOT using reverse proxy, manually map in certificates

    whoami-individual:
        image: traefik/whoami:latest
        container_name: whoami-individual
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true
        depends_on:
            - traefik
            - authentik_server
            - authentik_worker
        networks:
            - traefik
        environment:
            - TZ
        labels:
            - "traefik.enable=true"
            ## HTTP Routers
            - "traefik.http.routers.whoami-individual-rtr.rule=Host(`whoami-individual.${DOMAINNAME}`)"
            ## Middlewares
            - "traefik.http.routers.whoami-individual-rtr.middlewares=middlewares-authentik@file"

    whoami-catchall:
        image: traefik/whoami:latest
        container_name: whoami-catchall
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true
        depends_on:
            - traefik
            - authentik_server
            - authentik_worker
        networks:
            - traefik
        environment:
            - TZ
        labels:
            - "traefik.enable=true"
            ## HTTP Routers
            - "traefik.http.routers.whoami-catchall-rtr.rule=Host(`whoami-catchall.${DOMAINNAME}`)"
            ## Middlewares
            - "traefik.http.routers.whoami-catchall-rtr.middlewares=middlewares-authentik@file"
